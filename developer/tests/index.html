<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.2, mkdocs-material-7.2.4"><title>Tests - Cloud Custodian Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.f7f47774.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.3f5d1f46.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../_static/css/extra.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=yellow data-md-color-accent=deep-orange> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#testing-for-developers-developer-tests class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Cloud Custodian Documentation" class="md-header__button md-logo" aria-label="Cloud Custodian Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Cloud Custodian Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Tests </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=yellow data-md-color-accent=deep-orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=yellow data-md-color-accent=pink aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../actions/ class=md-tabs__link> Actions </a> </li> <li class=md-tabs__item> <a href=../../contribute/ class=md-tabs__link> Contribute </a> </li> <li class=md-tabs__item> <a href=../../deployment/ class=md-tabs__link> Deployment </a> </li> <li class=md-tabs__item> <a href=../../filters/ class=md-tabs__link> Generic Filters </a> </li> <li class=md-tabs__item> <a href=../../aws/contribute/ class=md-tabs__link> Aws </a> </li> <li class=md-tabs__item> <a href=../../azure/gettingstarted/ class=md-tabs__link> Azure </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Developer </a> </li> <li class=md-tabs__item> <a href=../../gcp/contribute/ class=md-tabs__link> Gcp </a> </li> <li class=md-tabs__item> <a href=../../quickstart/ class=md-tabs__link> Quickstart </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Cloud Custodian Documentation" class="md-nav__button md-logo" aria-label="Cloud Custodian Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Cloud Custodian Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../actions/ class=md-nav__link> Actions </a> </li> <li class=md-nav__item> <a href=../../contribute/ class=md-nav__link> Contribute </a> </li> <li class=md-nav__item> <a href=../../deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../filters/ class=md-nav__link> Generic Filters </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Aws <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Aws data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Aws </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/contribute/ class=md-nav__link> Contribute </a> </li> <li class=md-nav__item> <a href=../../aws/gettingstarted/ class=md-nav__link> Gettingstarted </a> </li> <li class=md-nav__item> <a href=../../aws/lambda/ class=md-nav__link> Lambda </a> </li> <li class=md-nav__item> <a href=../../aws/usage/ class=md-nav__link> Usage </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_5 type=checkbox id=__nav_6_5> <label class=md-nav__link for=__nav_6_5> Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Examples data-md-level=2> <label class=md-nav__title for=__nav_6_5> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/examples/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../aws/examples/accountinvalidiplogin/ class=md-nav__link> Accountinvalidiplogin </a> </li> <li class=md-nav__item> <a href=../../aws/examples/accountrootlogin/ class=md-nav__link> Accountrootlogin </a> </li> <li class=md-nav__item> <a href=../../aws/examples/accountservicelimit/ class=md-nav__link> Accountservicelimit </a> </li> <li class=md-nav__item> <a href=../../aws/examples/amicomp/ class=md-nav__link> Amicomp </a> </li> <li class=md-nav__item> <a href=../../aws/examples/asginvalidconfig/ class=md-nav__link> Asginvalidconfig </a> </li> <li class=md-nav__item> <a href=../../aws/examples/asgnotused/ class=md-nav__link> Asgnotused </a> </li> <li class=md-nav__item> <a href=../../aws/examples/asgoffhours/ class=md-nav__link> Asgoffhours </a> </li> <li class=md-nav__item> <a href=../../aws/examples/blocknonstandardregionresources/ class=md-nav__link> Blocknonstandardregionresources </a> </li> <li class=md-nav__item> <a href=../../aws/examples/dmsenforcessl/ class=md-nav__link> Dmsenforcessl </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ebsgarbagecollect/ class=md-nav__link> Ebsgarbagecollect </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ebssnapshots/ class=md-nav__link> Ebssnapshots </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ebsunencrypted/ class=md-nav__link> Ebsunencrypted </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ec2-auto-tag-user/ class=md-nav__link> Ec2 auto tag user </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ec2offhours/ class=md-nav__link> Ec2offhours </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ec2oldinstances/ class=md-nav__link> Ec2oldinstances </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ec2poweronstoppedforpatching/ class=md-nav__link> Ec2poweronstoppedforpatching </a> </li> <li class=md-nav__item> <a href=../../aws/examples/ec2unpatchedworkflow/ class=md-nav__link> Ec2unpatchedworkflow </a> </li> <li class=md-nav__item> <a href=../../aws/examples/eipgarbagecollect/ class=md-nav__link> Eipgarbagecollect </a> </li> <li class=md-nav__item> <a href=../../aws/examples/elbdeleteinetfacing/ class=md-nav__link> Elbdeleteinetfacing </a> </li> <li class=md-nav__item> <a href=../../aws/examples/elbgarbagecollection/ class=md-nav__link> Elbgarbagecollection </a> </li> <li class=md-nav__item> <a href=../../aws/examples/elbsslblacklist/ class=md-nav__link> Elbsslblacklist </a> </li> <li class=md-nav__item> <a href=../../aws/examples/elbsslwhitelist/ class=md-nav__link> Elbsslwhitelist </a> </li> <li class=md-nav__item> <a href=../../aws/examples/iamsetrolepolicy/ class=md-nav__link> Iamsetrolepolicy </a> </li> <li class=md-nav__item> <a href=../../aws/examples/lambdaerrorsnotify/ class=md-nav__link> Lambdaerrorsnotify </a> </li> <li class=md-nav__item> <a href=../../aws/examples/offhours/ class=md-nav__link> Offhours </a> </li> <li class=md-nav__item> <a href=../../aws/examples/rdsdeleteunused/ class=md-nav__link> Rdsdeleteunused </a> </li> <li class=md-nav__item> <a href=../../aws/examples/rdspublicunencrypted/ class=md-nav__link> Rdspublicunencrypted </a> </li> <li class=md-nav__item> <a href=../../aws/examples/s3configurenewbucket/ class=md-nav__link> S3configurenewbucket </a> </li> <li class=md-nav__item> <a href=../../aws/examples/s3denypublicobjectacls/ class=md-nav__link> S3denypublicobjectacls </a> </li> <li class=md-nav__item> <a href=../../aws/examples/s3encryption/ class=md-nav__link> S3encryption </a> </li> <li class=md-nav__item> <a href=../../aws/examples/s3globalgrants/ class=md-nav__link> S3globalgrants </a> </li> <li class=md-nav__item> <a href=../../aws/examples/sagemakernotebookdeletepublicorunencrypted/ class=md-nav__link> Sagemakernotebookdeletepublicorunencrypted </a> </li> <li class=md-nav__item> <a href=../../aws/examples/securitygroupsaddpermission/ class=md-nav__link> Securitygroupsaddpermission </a> </li> <li class=md-nav__item> <a href=../../aws/examples/securitygroupsdetectremediate/ class=md-nav__link> Securitygroupsdetectremediate </a> </li> <li class=md-nav__item> <a href=../../aws/examples/tagcompliance/ class=md-nav__link> Tagcompliance </a> </li> <li class=md-nav__item> <a href=../../aws/examples/vpcflowlog/ class=md-nav__link> Vpcflowlog </a> </li> <li class=md-nav__item> <a href=../../aws/examples/vpcpeeringcrossaccount/ class=md-nav__link> Vpcpeeringcrossaccount </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_6 type=checkbox id=__nav_6_6> <label class=md-nav__link for=__nav_6_6> Topics <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Topics data-md-level=2> <label class=md-nav__title for=__nav_6_6> <span class="md-nav__icon md-icon"></span> Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/topics/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../aws/topics/config/ class=md-nav__link> Config </a> </li> <li class=md-nav__item> <a href=../../aws/topics/securityhub/ class=md-nav__link> Securityhub </a> </li> <li class=md-nav__item> <a href=../../aws/topics/ssm/ class=md-nav__link> Ssm </a> </li> <li class=md-nav__item> <a href=../../aws/topics/xray/ class=md-nav__link> Xray </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Azure <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Azure data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Azure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../azure/gettingstarted/ class=md-nav__link> Gettingstarted </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_2 type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2> Advanced <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Advanced data-md-level=2> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../azure/advanced/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../azure/advanced/azurepolicy/ class=md-nav__link> Azurepolicy </a> </li> <li class=md-nav__item> <a href=../../azure/advanced/contribute/ class=md-nav__link> Contribute </a> </li> <li class=md-nav__item> <a href=../../azure/advanced/multiplesubs/ class=md-nav__link> Multiplesubs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_3 type=checkbox id=__nav_7_3> <label class=md-nav__link for=__nav_7_3> Configuration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Configuration data-md-level=2> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../azure/configuration/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/acitutorial/ class=md-nav__link> Acitutorial </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/authentication/ class=md-nav__link> Authentication </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/containerhosting/ class=md-nav__link> Containerhosting </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/functionshosting/ class=md-nav__link> Functionshosting </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/helmtutorial/ class=md-nav__link> Helmtutorial </a> </li> <li class=md-nav__item> <a href=../../azure/configuration/monitoring/ class=md-nav__link> Monitoring </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_4 type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4> Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Examples data-md-level=2> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../azure/examples/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../azure/examples/appservicecors-compute/ class=md-nav__link> Appservicecors compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/appserviceplansresize-compute/ class=md-nav__link> Appserviceplansresize compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/cosmosdb-collection-on-off-hours-databases/ class=md-nav__link> Cosmosdb collection on off hours databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/emailnotify-notifications/ class=md-nav__link> Emailnotify notifications </a> </li> <li class=md-nav__item> <a href=../../azure/examples/firewall-cosmosaction-networking/ class=md-nav__link> Firewall cosmosaction networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/firewall-rulesfiltering-networking/ class=md-nav__link> Firewall rulesfiltering networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/loadbalancerfilterbyfrotendip-networking/ class=md-nav__link> Loadbalancerfilterbyfrotendip networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/metrics-general/ class=md-nav__link> Metrics general </a> </li> <li class=md-nav__item> <a href=../../azure/examples/networksecuritygroups-networking/ class=md-nav__link> Networksecuritygroups networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/resourcegroupsdelayedoperation-general/ class=md-nav__link> Resourcegroupsdelayedoperation general </a> </li> <li class=md-nav__item> <a href=../../azure/examples/resourcegroupsorphanresources-general-compute-networking/ class=md-nav__link> Resourcegroupsorphanresources general compute networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/resourcegroupsremoveempty-general/ class=md-nav__link> Resourcegroupsremoveempty general </a> </li> <li class=md-nav__item> <a href=../../azure/examples/routetablewithsubnet-networking/ class=md-nav__link> Routetablewithsubnet networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/sqldatabasebackupretention-databases/ class=md-nav__link> Sqldatabasebackupretention databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/sqldatabaseupdateretentionpolicies-databases/ class=md-nav__link> Sqldatabaseupdateretentionpolicies databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/sqldatabasewithpremiumsku-databases/ class=md-nav__link> Sqldatabasewithpremiumsku databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/storageaddfirewallrulestostorage-databases-networking/ class=md-nav__link> Storageaddfirewallrulestostorage databases networking </a> </li> <li class=md-nav__item> <a href=../../azure/examples/storageblockpublicaccess-networking-databases/ class=md-nav__link> Storageblockpublicaccess networking databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/storagecontainerevent-databases/ class=md-nav__link> Storagecontainerevent databases </a> </li> <li class=md-nav__item> <a href=../../azure/examples/tagadd-general-compute/ class=md-nav__link> Tagadd general compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/tagautotagusers-general-identity/ class=md-nav__link> Tagautotagusers general identity </a> </li> <li class=md-nav__item> <a href=../../azure/examples/tagremove-general-compute/ class=md-nav__link> Tagremove general compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/tagtrim-general-compute/ class=md-nav__link> Tagtrim general compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/teamsnewresourcegroup-general-notifications/ class=md-nav__link> Teamsnewresourcegroup general notifications </a> </li> <li class=md-nav__item> <a href=../../azure/examples/virtualmachinesstoppedvm-compute/ class=md-nav__link> Virtualmachinesstoppedvm compute </a> </li> <li class=md-nav__item> <a href=../../azure/examples/virtualmachineswithpublicip-compute-networking/ class=md-nav__link> Virtualmachineswithpublicip compute networking </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_4_28 type=checkbox id=__nav_7_4_28> <label class=md-nav__link for=__nav_7_4_28> Logicappnotifications <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Logicappnotifications data-md-level=3> <label class=md-nav__title for=__nav_7_4_28> <span class="md-nav__icon md-icon"></span> Logicappnotifications </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../azure/examples/logicappnotifications/logicappnotification/ class=md-nav__link> Logicappnotification </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8 checked> <label class=md-nav__link for=__nav_8> Developer <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Developer data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Developer </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../documentation/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../installing/ class=md-nav__link> Installing </a> </li> <li class=md-nav__item> <a href=../packaging/ class=md-nav__link> Packaging </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> Tests </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9 type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9> Gcp <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Gcp data-md-level=1> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Gcp </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcp/contribute/ class=md-nav__link> Contribute </a> </li> <li class=md-nav__item> <a href=../../gcp/gettingstarted/ class=md-nav__link> Gettingstarted </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9_3 type=checkbox id=__nav_9_3> <label class=md-nav__link for=__nav_9_3> Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Examples data-md-level=2> <label class=md-nav__title for=__nav_9_3> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcp/examples/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/appengine-certificates/ class=md-nav__link> Appengine certificates </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/appengine-domain/ class=md-nav__link> Appengine domain </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/appengine-firewall-ingress-rule/ class=md-nav__link> Appengine firewall ingress rule </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/dataflow-job/ class=md-nav__link> Dataflow job </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/dm-deployments/ class=md-nav__link> Dm deployments </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/dns-managed-zone/ class=md-nav__link> Dns managed zone </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/dns-policy/ class=md-nav__link> Dns policy </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/gce-autoscaler/ class=md-nav__link> Gce autoscaler </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/gce-instance-template/ class=md-nav__link> Gce instance template </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/kms-cryptokey/ class=md-nav__link> Kms cryptokey </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/loadbalancer-delete-backend-buckets/ class=md-nav__link> Loadbalancer delete backend buckets </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/loadbalancer-network-tiers/ class=md-nav__link> Loadbalancer network tiers </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/loadbalancer-ssl-policy-delete-old-versions/ class=md-nav__link> Loadbalancer ssl policy delete old versions </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/pubsub-snapshots/ class=md-nav__link> Pubsub snapshots </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/pubsub-subscriptions/ class=md-nav__link> Pubsub subscriptions </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/spanner-drop-databases/ class=md-nav__link> Spanner drop databases </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/spanner-reduce-instances-count/ class=md-nav__link> Spanner reduce instances count </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/spanner-set-iam-policy/ class=md-nav__link> Spanner set iam policy </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/sql-backupruns/ class=md-nav__link> Sql backupruns </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/sql-instance/ class=md-nav__link> Sql instance </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/sql-sslcerts/ class=md-nav__link> Sql sslcerts </a> </li> <li class=md-nav__item> <a href=../../gcp/examples/sql-users/ class=md-nav__link> Sql users </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9_4 type=checkbox id=__nav_9_4> <label class=md-nav__link for=__nav_9_4> Policy <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Policy data-md-level=2> <label class=md-nav__title for=__nav_9_4> <span class="md-nav__icon md-icon"></span> Policy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcp/policy/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../gcp/policy/genericgcpactions/ class=md-nav__link> Genericgcpactions </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9_4_3 type=checkbox id=__nav_9_4_3> <label class=md-nav__link for=__nav_9_4_3> Resources <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Resources data-md-level=3> <label class=md-nav__title for=__nav_9_4_3> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gcp/policy/resources/loadbalancer/ class=md-nav__link> Loadbalancer </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_10 type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10> Quickstart <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Quickstart data-md-level=1> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Quickstart </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../quickstart/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../quickstart/advanced/ class=md-nav__link> Advanced </a> </li> <li class=md-nav__item> <a href=../../quickstart/policyStructure/ class=md-nav__link> policyStructure </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=testing-for-developers-developer-tests>Testing for Developers {#developer-tests}<a class=headerlink href=#testing-for-developers-developer-tests title="Permanent link">&para;</a></h1> <h2 id=running-tests>Running tests<a class=headerlink href=#running-tests title="Permanent link">&para;</a></h2> <p>Unit tests can be run with:</p> <div class=highlight><pre><span></span><code>$ tox
</code></pre></div> <p>Linting can be run with:</p> <div class=highlight><pre><span></span><code>$ make lint
</code></pre></div> <p>To run tests directly with pytest, or to integrate into your IDE, you can reference <code>tox.ini</code> for the appropriate commands and environment variable configuration. Testing done without <code>C7N_TEST_RUN</code> and <code>C7N_VALIDATE</code> may not match <code>tox</code> results.</p> <h2 id=operating-system-compatibility>Operating System Compatibility<a class=headerlink href=#operating-system-compatibility title="Permanent link">&para;</a></h2> <p>Tests are currently executed on both Ubuntu 1804 and Windows Server 2019 and must pass on both operating systems.</p> <p>Both Windows and Linux sample dockerfiles are provided for running Tox which may help you. You can find these in [tools/dev]{.title-ref}.</p> <p>In Docker for Windows you can run both of these containers, <a href=https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/linux-containers>even simultaneously</a>.</p> <p>If you need access to Windows you can download a <a href=https://developer.microsoft.com/en-us/windows/downloads/virtual-machines>virtual machine</a> directly from Microsoft for any hypervisor.</p> <h2 id=writing-tests-for-cloud-controlled-resources>Writing Tests for Cloud Controlled Resources<a class=headerlink href=#writing-tests-for-cloud-controlled-resources title="Permanent link">&para;</a></h2> <p>Cloud Custodian makes use of flight recording to allow for both functional and unit testing. Each of the custodian providers uses a separate technique that integrates with the provider sdk to handle flight recording of custodian\'s api calls, we provide a common abstraction over that in our testing framework via record_flight_data/replay_flight_data/</p> <p>For setting up infrastructure to execute/test policies against we use the pytest-terraform library.</p> <blockquote> <ul> <li><a href=https://github.com/cloud-custodian/pytest-terraform>Pytest Terraform</a> a Pytest Plugin leveraging terraform to setup test environments</li> </ul> </blockquote> <h3 id=creating-cloud-resources-with-terraform-creating-tests>Creating Cloud Resources with Terraform {#Creating Tests}<a class=headerlink href=#creating-cloud-resources-with-terraform-creating-tests title="Permanent link">&para;</a></h3> <p>If a test requires pre-existing cloud resources in order to operate, [pytest-terraform]{.title-ref} is the preferred method for creating those resources. Pytest Terraform uses <a href=https://terraform.io>Terraform</a> to repeatably &amp; reliably stand up cloud resources. Make sure you have installed terraform and the <code>terraform</code> command is available in your shell\'s PATH.</p> <div class=highlight><pre><span></span><code>$ terraform version
</code></pre></div> <p>In addition to a working terraform installation, credentials and configuration for the target cloud will need to be completed. <a href=https://learn.hashicorp.com/terraform>Getting started with Terraform</a></p> <p>Pytest Terraform looks for matching modules in the <code>tests/terraform</code> directory. So for a test named <code>test_file_example</code> the terraform files for that test will be in <code>tests/terraform/file_example</code>.</p> <p>Here\'s an example terraform file for the upcoming example. It is placed in <code>tests/terraform/file_example/main.tf</code>.</p> <blockquote> <div class=highlight><pre><span></span><code><span class=kr>resource</span> <span class=nc>&quot;local_file&quot;</span> <span class=nv>&quot;bar&quot;</span> <span class=p>{</span>
   <span class=na>content</span> <span class=o>=</span> <span class=s2>&quot;bar!&quot;</span>
   <span class=na>filename</span> <span class=o>=</span> <span class=s2>&quot;${path.module}/bar.txt&quot;</span>
<span class=p>}</span>
</code></pre></div> </blockquote> <p>When invoked, this terraform module will create a file <code>bar.txt</code> with the contents <code>bar!</code>.</p> <p>In order to access this terraform module, import and wrap a test method with the <code>@terraform</code> decorator. The decorator takes one required positional argument, the name of the module, which in the above example is <code>file_example</code>. In addition to the single positional argument, there are <a href=https://github.com/cloud-custodian/pytest-terraform#usage>several keyword arguments</a> to control how the decorator operates.</p> <p>The following code example demonstrates how to run and interact with the previous terraform file.</p> <blockquote> <div class=highlight><pre><span></span><code><span class=nd>@terraform</span><span class=p>(</span><span class=s1>&#39;file_example&#39;</span><span class=p>,</span> <span class=n>replay</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_file_example</span><span class=p>(</span><span class=n>file_example</span><span class=p>):</span>
    <span class=k>assert</span> <span class=n>file_example</span><span class=p>[</span><span class=s1>&#39;local_file.bar.content&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;bar!&#39;</span>
</code></pre></div> </blockquote> <p>When first creating a test, explicitly set the <code>replay</code> parameter to <code>False</code>. This will force terraform to run on each invocation of the test and perform the flight recording function.</p> <p>The outputs and results of the terraform run are available via the fixture passed into the test method. The fixture will always be named after the terraform module supplied in the first parameter to the decorator, in this case <code>file_example</code>. Pytest Terraform uses JMSEPath lookups, so in order to get the content of the <code>bar</code> resource <code>local_file.bar.content</code> is supplied as the item for lookup.</p> <p>Run this test using the following command, which will also generate flight recordings for terraform:</p> <blockquote> <div class=highlight><pre><span></span><code>$ pytest tests/path/to/test.py -s -v -k <span class=s1>&#39;test_file_example&#39;</span>
</code></pre></div> </blockquote> <p>This may take a little while as tests are typically interacting with the cloud. All terraform state is recorded in the same directory of the terraform module as a <code>tf_resources.json</code> file.</p> <blockquote> <div class=highlight><pre><span></span><code>$ ls tests/terraform/file_example/
main.tf
tf_resources.json
</code></pre></div> </blockquote> <p>Each invocation of the test where replay is <code>False</code>, the <code>tf_resources.json</code> contents are replaced and updated with that runs output.</p> <p>When the test is completed, remove <code>replay=False</code> in order to switch to replay mode by default.</p> <blockquote> <div class=highlight><pre><span></span><code><span class=nd>@terraform</span><span class=p>(</span><span class=s1>&#39;file_example&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_file_example</span><span class=p>(</span><span class=n>file_example</span><span class=p>):</span>

    <span class=k>assert</span> <span class=n>file_example</span><span class=p>[</span><span class=s1>&#39;local_file.bar.content&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;bar!&#39;</span>
</code></pre></div> </blockquote> <p>Now when the test is run it will use the data previously recorded terraform resources and not run terraform directly. When committing your test, don\'t forget to include the <code>tests/terraform/file_example</code> directory!</p> <p>If your test performs destructive actions against a cloud resource created by terraform, check out <a href=#controlling-resource-cleanup>Controlling Resource Cleanup</a></p> <h3 id=recording-custodian-interactions>Recording Custodian Interactions<a class=headerlink href=#recording-custodian-interactions title="Permanent link">&para;</a></h3> <p>Cloud Custodian tests provide a pytest fixture, <code>test</code>, that provides access to common unittest methods (such as <code>assertEqual</code>) as well as the placebo based test methods. In order to write a placebo enabled test two helper methods are provided:</p> <blockquote> <ul> <li><code>record_flight_data</code> - use this when creating the test</li> <li><code>replay_flight_data</code> - use this when the test is completed</li> </ul> </blockquote> <p>When first creating a test, use the <code>record_flight_data</code> method. This will contact the cloud and store all responses as files in the placebo directory (<code>tests/data/placebo/</code>). The method takes one parameter, which is the directory name to store placebo output in and it must be unique across all tests. For example:</p> <blockquote> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_example</span><span class=p>(</span><span class=n>test</span><span class=p>):</span>
    <span class=n>session_factory</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>record_flight_data</span><span class=p>(</span><span class=s1>&#39;test_example&#39;</span><span class=p>)</span>

    <span class=n>policy</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;list-ec2-instances&#39;</span><span class=p>,</span>
        <span class=s1>&#39;resource&#39;</span><span class=p>:</span> <span class=s1>&#39;aws.ec2&#39;</span><span class=p>,</span>
    <span class=p>}</span>

    <span class=n>policy</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>load_policy</span><span class=p>(</span>
        <span class=n>policy</span><span class=p>,</span>
        <span class=n>session_factory</span><span class=o>=</span><span class=n>session_factory</span>
    <span class=p>)</span>

    <span class=n>resources</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
    <span class=n>test</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</code></pre></div> </blockquote> <p>Now run this test using the following command to generate the placebo data:</p> <blockquote> <div class=highlight><pre><span></span><code>$ pytest tests/path/to/test.py -s -v
</code></pre></div> </blockquote> <p>This may take a little while as the test is contacting AWS. All responses are stored in the placebo directory, and can be viewed when the test is finished. It is not necessary to inspect these files, but they can be helpful if the test is not behaving how you expect.</p> <blockquote> <div class=highlight><pre><span></span><code>$ ls tests/data/placebo/test_example/
ec2.DescribeInstances_1.json
ec2.DescribeTags_1.json
</code></pre></div> </blockquote> <p>If it is necessary to run the test again - for example, if the test fails, or if it is not yet fully complete - you can run with <code>record_flight_data</code> as many times as necessary. The contents of the directory will be cleared each time the test is run while <code>record_flight_data</code> is in place.</p> <p>When the test is completed, change to using <code>replay_flight_data</code>:</p> <blockquote> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_example</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>test</span><span class=p>):</span>
    <span class=n>session_factory</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>replay_flight_data</span><span class=p>(</span><span class=s1>&#39;test_example&#39;</span><span class=p>)</span>

    <span class=o>...</span>
</code></pre></div> </blockquote> <p>Now when the test is run it will use the data previously recorded and will not contact the cloud. When committing your test, don\'t forget to include the <code>tests/data/placebo/test_example</code> directory!</p> <p>Note: If it\'s necessary to delay CLI calls due to delays in the time it takes for an attribute on a resource to be reflected in an API call or any other reason, use <code>test.recording</code> to only sleep when recording json like so:</p> <blockquote> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>time</span>

<span class=o>...</span>

<span class=k>def</span> <span class=nf>test_example</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>test</span><span class=p>):</span>

    <span class=o>...</span>

    <span class=k>if</span> <span class=n>test</span><span class=o>.</span><span class=n>recording</span><span class=p>:</span>
        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</code></pre></div> </blockquote> <h3 id=controlling-resource-cleanup>Controlling Resource Cleanup<a class=headerlink href=#controlling-resource-cleanup title="Permanent link">&para;</a></h3> <p>If terraform destroy command fails during cleanup, it will mark the test as failed. For tests that perform destructive actions against terraform managed resources there is an option to tune how pytest-terraform performs this cleanup operation.</p> <p>There are three options available for the <code>teardown</code> parameter:</p> <blockquote> <ul> <li>[terraform.TEARDOWN_ON]{.title-ref} - Always perform terraform cleanup, fail on error</li> <li>[terraform.TEARDOWN_OFF]{.title-ref} - Never perform the terraform cleanup</li> <li>[terraform.TEARDOWN_IGNORE]{.title-ref} - Always perform the terraform cleanup, ignore errors</li> </ul> </blockquote> <p>In general, [TEARDOWN_ON]{.title-ref} and [TEARDOWN_IGNORE]{.title-ref} are used for test teardown. For debugging purposes [TEARDOWN_OFF]{.title-ref} is provided allowing test authors to inspect cloud entities after each test run.</p> <p>In this example we create a new SQS and a policy to delete it then assert it is deleted. To avoid terraform erroring on teardown [TEARDOWN_IGNORE]{.title-ref} is used.</p> <blockquote> <div class=highlight><pre><span></span><code><span class=kr>provider</span> <span class=nv>&quot;aws&quot;</span> <span class=p>{</span><span class=err>}</span>

<span class=kr>resource</span> <span class=nc>&quot;aws_sqs_queue&quot;</span> <span class=nv>&quot;test_sqs&quot;</span> <span class=p>{</span>
  <span class=na>name</span> <span class=o>=</span> <span class=s2>&quot;delete-me&quot;</span>
<span class=p>}</span>
</code></pre></div> </blockquote> <p>The following test uses the above [sqs_delete]{.title-ref} terraform module:</p> <blockquote> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pytest_terraform</span> <span class=kn>import</span> <span class=n>terraform</span>


<span class=nd>@terraform</span><span class=p>(</span><span class=s1>&#39;sqs_delete&#39;</span><span class=p>,</span> <span class=n>teardown</span><span class=o>=</span><span class=n>terraform</span><span class=o>.</span><span class=n>TEARDOWN_IGNORE</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_sqs_delete</span><span class=p>(</span><span class=n>test</span><span class=p>,</span> <span class=n>sqs_delete</span><span class=p>):</span>
    <span class=c1># Create a placebo record/replay session.</span>
    <span class=n>session_factory</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>replay_flight_data</span><span class=p>(</span><span class=s2>&quot;test_sqs_delete&quot;</span><span class=p>)</span>
    <span class=n>client</span> <span class=o>=</span> <span class=n>session_factory</span><span class=p>()</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&quot;sqs&quot;</span><span class=p>)</span>

    <span class=c1># Extract Queue ARN from terraform output</span>
    <span class=n>queue_arn</span> <span class=o>=</span> <span class=n>sqs_delete</span><span class=p>[</span><span class=s2>&quot;aws_sqs_queue.test_sqs.arn&quot;</span><span class=p>]</span>

    <span class=c1># Create a policy that will delete any matched resources</span>
    <span class=n>p</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>load_policy</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs-delete&quot;</span><span class=p>,</span>
            <span class=s2>&quot;resource&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs&quot;</span><span class=p>,</span>
            <span class=s2>&quot;filters&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;QueueArn&quot;</span><span class=p>:</span> <span class=n>queue_arn</span><span class=p>}],</span>
            <span class=s2>&quot;actions&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;delete&quot;</span><span class=p>}],</span>
        <span class=p>},</span>
        <span class=n>session_factory</span><span class=o>=</span><span class=n>session_factory</span><span class=p>,</span>
    <span class=p>)</span>

    <span class=n>resources</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
    <span class=c1># Checks to make sure our single test queue was found</span>
    <span class=n>test</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>

    <span class=c1># Extract the QueueURL from the filtered resource</span>
    <span class=n>queue_url</span> <span class=o>=</span> <span class=n>resources</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;QueueUrl&#39;</span><span class=p>]</span>

    <span class=c1># Attempt to delete the queue and expect AWS API to produce an error</span>
    <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=n>ClientError</span><span class=p>,</span> <span class=n>client</span><span class=o>.</span><span class=n>purge_queue</span><span class=p>,</span> <span class=n>QueueUrl</span><span class=o>=</span><span class=n>queue_url</span><span class=p>)</span>
</code></pre></div> </blockquote> <h2 id=converting-older-functional-tests-converting-tests>Converting older functional tests {#Converting Tests}<a class=headerlink href=#converting-older-functional-tests-converting-tests title="Permanent link">&para;</a></h2> <p>Before the introduction of pytest-terraform many functional tests were wrapped with <code>@functional</code> and used class-based tests which inherited <code>BaseTest</code>.</p> <p>To convert a previous functional testing to use the preferred pytest-terraform method outlined above, first move the method to either a base class which does not inherit <code>BaseTest</code> as pytest does not support fixtures with unittest derived classes, alternatively convert the test to a function.</p> <p>Once the test method has been relocated, replace any references to <code>@functional</code> with the appropriate <code>@terraform</code> decorator from <a href=#creating-cloud-resources-with-terraform>Creating Cloud Resources with Terraform</a>.</p> <p>Finally, replace all mentions of <code>self</code> with the <code>test</code> fixture outlined in <a href=#recording-custodian-interactions>Recording Custodian Interactions</a> Before committing any changes, the tests should be run explicitly in record mode to capture all new changes in flight data.</p> <p>Below is an example, older, functional test</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>TestSqs</span><span class=p>(</span><span class=n>BaseTest</span><span class=p>):</span>

    <span class=nd>@functional</span>
    <span class=k>def</span> <span class=nf>test_sqs_delete</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>session_factory</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>replay_flight_data</span><span class=p>(</span><span class=s2>&quot;test_sqs_delete&quot;</span><span class=p>)</span>
        <span class=n>client</span> <span class=o>=</span> <span class=n>session_factory</span><span class=p>()</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&quot;sqs&quot;</span><span class=p>)</span>
        <span class=n>client</span><span class=o>.</span><span class=n>create_queue</span><span class=p>(</span><span class=n>QueueName</span><span class=o>=</span><span class=s2>&quot;test-sqs&quot;</span><span class=p>)</span>
        <span class=n>queue_url</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_queue_url</span><span class=p>(</span><span class=n>QueueName</span><span class=o>=</span><span class=s2>&quot;test-sqs&quot;</span><span class=p>)[</span><span class=s2>&quot;QueueUrl&quot;</span><span class=p>]</span>

        <span class=n>p</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_policy</span><span class=p>(</span>
            <span class=p>{</span>
                <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs-delete&quot;</span><span class=p>,</span>
                <span class=s2>&quot;resource&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs&quot;</span><span class=p>,</span>
                <span class=s2>&quot;filters&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;QueueUrl&quot;</span><span class=p>:</span> <span class=n>queue_url</span><span class=p>}],</span>
                <span class=s2>&quot;actions&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;delete&quot;</span><span class=p>}],</span>
            <span class=p>},</span>
            <span class=n>session_factory</span><span class=o>=</span><span class=n>session_factory</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>resources</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertRaises</span><span class=p>(</span><span class=n>ClientError</span><span class=p>,</span> <span class=n>client</span><span class=o>.</span><span class=n>purge_queue</span><span class=p>,</span> <span class=n>QueueUrl</span><span class=o>=</span><span class=n>queue_url</span><span class=p>)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>recording</span><span class=p>:</span>
            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span>
</code></pre></div> <p>This can be replaced with a new <code>sqs_delete</code> terraform module and the following code:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pytest_terraform</span> <span class=kn>import</span> <span class=n>terraform</span>


<span class=nd>@terraform</span><span class=p>(</span><span class=s1>&#39;sqs_delete&#39;</span><span class=p>,</span> <span class=n>teardown</span><span class=o>=</span><span class=n>terraform</span><span class=o>.</span><span class=n>TEARDOWN_IGNORE</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_sqs_delete</span><span class=p>(</span><span class=n>test</span><span class=p>,</span> <span class=n>sqs_delete</span><span class=p>):</span>
    <span class=n>session_factory</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>replay_flight_data</span><span class=p>(</span><span class=s2>&quot;test_sqs_delete&quot;</span><span class=p>)</span>
    <span class=n>client</span> <span class=o>=</span> <span class=n>session_factory</span><span class=p>()</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&quot;sqs&quot;</span><span class=p>)</span>

    <span class=n>queue_arn</span> <span class=o>=</span> <span class=n>sqs_delete</span><span class=p>[</span><span class=s2>&quot;aws_sqs_queue.test_sqs.arn&quot;</span><span class=p>]</span>

    <span class=n>p</span> <span class=o>=</span> <span class=n>test</span><span class=o>.</span><span class=n>load_policy</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs-delete&quot;</span><span class=p>,</span>
            <span class=s2>&quot;resource&quot;</span><span class=p>:</span> <span class=s2>&quot;sqs&quot;</span><span class=p>,</span>
            <span class=s2>&quot;filters&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;QueueArn&quot;</span><span class=p>:</span> <span class=n>queue_arn</span><span class=p>}],</span>
            <span class=s2>&quot;actions&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;delete&quot;</span><span class=p>}],</span>
        <span class=p>},</span>
        <span class=n>session_factory</span><span class=o>=</span><span class=n>session_factory</span><span class=p>,</span>
    <span class=p>)</span>

    <span class=n>resources</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
    <span class=n>test</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
    <span class=n>queue_url</span> <span class=o>=</span> <span class=n>resources</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;QueueUrl&#39;</span><span class=p>]</span>
    <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=n>ClientError</span><span class=p>,</span> <span class=n>client</span><span class=o>.</span><span class=n>purge_queue</span><span class=p>,</span> <span class=n>QueueUrl</span><span class=o>=</span><span class=n>queue_url</span><span class=p>)</span>
</code></pre></div> <hr> <div class=md-source-date> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2021-08-23 19:02:35</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../packaging/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Packaging" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Packaging </div> </div> </a> <a href=../../gcp/contribute/ class="md-footer__link md-footer__link--next" aria-label="Next: Contribute" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Contribute </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2021 The Cloud Custodian Authors </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tracking", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "tabs", "instant", "search.suggest", "search.highlight", "search.share"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script> <script src=../../assets/javascripts/bundle.febc23d1.min.js></script> </body> </html>